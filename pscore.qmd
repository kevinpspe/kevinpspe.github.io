# Propensity Score Matching {.unnumbered}

Mia is in our study and receives the treatment. Mia's causal effect is:

$$
\tau_{\text{Mia}} = \textcolor{purple}{Y^{(1)}_\text{Mia}} - \textcolor{red}{Y^{(0)}_\text{Mia}}
$$

::: small
The counterfactual outcome (not observed) is in red.
:::

We cannot observe Mia's counterfactual. However, what we can do is to find an untreated individual similar to Mia to approximate Mia's counterfactual:

$$
\tau_{\text{Mia}} \approx \textcolor{purple}{Y^{(1)}_\text{Mia}} - \textcolor{purple}{Y^{(0)}_\text{Matched individual}} 
$$

Propensity Score Matching matches an individual that is treated (like Mia) with one that is not treated based on how similar their likelihoods of treatment are.

What is a likelihood of treatment? Well we know confounders cause people to get the treatment or not treatment. Thus, using an individual's confounder values, we can estimate their likelihood of getting treatment, called a propensity score.

$$
\text{propensity score } \pi =Pr(\text{you get treated}) 
$$

::: small
Propensity scores are typically estimated with a logistic regression, although in recent years, more researchers have started to use machine learning methods.
:::

::: {.callout-note appearance="minimal"}
<div>

**Kevin's Estimator Score**: <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i> (2/5)

-   Propensity score matching performs worse than [genetic matching](genetic.qmd). However it is much quicker to estimate, so in larger datasets, you might consider to use distance matching.
-   **You should not use propensity score matching on small datasets**, as it can be badly biased, as the logistic regression used to estimate propensity scores relies on asymptotic consistency.
-   All matching methods are data inefficient - they will throw out unmatched data, and this can greatly reduce our sample sizes.
-   Matching is non-parametric, so it does not assume a linear relationship like regression.

::: small
There are also some (advanced) criticisms of propensity score matching outlined [here](https://gking.harvard.edu/publications/why-propensity-scores-should-not-be-used-formatching).
:::

</div>
:::

Before you implement propensity score matching, make sure you have reasons to believe you meet the neccessary assumptions for selection on observables:

1.  Conditional Ignorability
2.  Common Support
3.  Stable Unit Treatment Value Assumption (SUTVA)

We will need the **Matching** package.

```{r, eval = FALSE}
library(Matching)
```

First, we need to estimate the propensity scores with a logistic regression:

```{r, eval = FALSE}
propensity <- glm(D ~ X1 + X2,
                  data = my_data,
                  family = "binomial")
my_data$pscore <- predict(propensity,
                          type = "response")
```

::: small
A random forest model is also possible, but less common.
:::

Now, we can implement the matching as follows.

```{r, eval = FALSE}
att <- Match(Y = my_data$Y,
             Tr = my_data$D,
             X = my_data[,"pscore"],
             M = 1,
             BiasAdjust = TRUE,
             Weight = 2)
summary(att)
```

Our output estimate will be the ATT.
